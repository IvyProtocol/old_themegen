#!/usr/bin/env bash
# wallbash - generate adaptive color palette for Hyprland, kitty, etc.

WALLPAPER="/home/Kroni4/Pictures/wallpapers/aurora_borealis.jpg"
OUTPUT="$HOME/.config/main/wallbash/colors.dcol"
THEME="$HOME/.config/main/wallbash/theme.dcol"

mkdir -p "$(dirname "$OUTPUT")" "$(dirname "$THEME")"

NUM_COLORS=16

# Hex → RGBA
hex_to_rgba() {
    local hex=${1#"#"}
    local r=$((16#${hex:0:2}))
    local g=$((16#${hex:2:2}))
    local b=$((16#${hex:4:2}))
    echo "rgba($r,$g,$b,1.0)"
}

# Compute perceived brightness (0..255)
brightness() {
    local hex=${1#"#"}
    local r=$((16#${hex:0:2}))
    local g=$((16#${hex:2:2}))
    local b=$((16#${hex:4:2}))
    awk "BEGIN{print int(0.299*$r + 0.587*$g + 0.114*$b)}"
}

# Extract top NUM_COLORS colors
mapfile -t HEX_COLORS < <(magick convert "$WALLPAPER" -resize 50x50! -colors "$NUM_COLORS" +dither -format "%c" histogram:info:- \
    | sort -nr | head -n "$NUM_COLORS" \
    | awk '{gsub("#","",$3); print "#"substr($3,1,6)}'
)

# Clear old files
> "$OUTPUT"
> "$THEME"

# Sort colors by brightness (dark → light)
mapfile -t SORTED_COLORS < <(for c in "${HEX_COLORS[@]}"; do
    echo "$(brightness "$c") $c"
done | sort -n | awk '{print $2}')

# Assign roles
DARK_BG=${SORTED_COLORS[0]:-#000000}
LIGHT_FG=${SORTED_COLORS[-1]:-#ffffff}
ACCENT=${SORTED_COLORS[$((NUM_COLORS/2))]:-#888888}

# Smart border assignment
BG_BRIGHT=$(brightness "$DARK_BG")

# Find color with maximum brightness difference to background
ACTIVE_BORDER=$(for c in "${HEX_COLORS[@]}"; do
    echo "$(awk "BEGIN{print sqrt(($BG_BRIGHT - $(brightness "$c"))^2)}") $c"
done | sort -nr | head -n1 | awk '{print $2}')

# Find color with second-highest difference for inactive
INACTIVE_BORDER=$(for c in "${HEX_COLORS[@]}"; do
    echo "$(awk "BEGIN{print sqrt(($BG_BRIGHT - $(brightness "$c"))^2)}") $c"
done | sort -nr | sed -n '2p' | awk '{print $2}')

# Write colors and roles
for i in $(seq 0 $((NUM_COLORS-1))); do
    hex=${HEX_COLORS[i]:-#000000}
    rgba=$(hex_to_rgba "$hex")
    echo "\$wallbash.colors$i=$rgba" >> "$OUTPUT"
    echo "wallbash_colors$i=$hex" >> "$THEME"
done

# Foreground / Background / Accent
echo "\$wallbash.background-primary=$(hex_to_rgba "$DARK_BG")" >> "$OUTPUT"
echo "\$wallbash.foreground-primary=$(hex_to_rgba "$LIGHT_FG")" >> "$OUTPUT"
echo "\$wallbash.accent-primary=$(hex_to_rgba "$ACCENT")" >> "$OUTPUT"

echo "wallbash_background_primary=$DARK_BG" >> "$THEME"
echo "wallbash_foreground_primary=$LIGHT_FG" >> "$THEME"
echo "wallbash_accent_primary=$ACCENT" >> "$THEME"
echo "wallbash_border_active=$ACTIVE_BORDER" >> "$THEME"
echo "wallbash_border_inactive=$INACTIVE_BORDER" >> "$THEME"

# Active / Inactive borders
echo "\$wallbash.border-active=$(hex_to_rgba "$ACTIVE_BORDER")" >> "$OUTPUT"
echo "\$wallbash.border-inactive=$(hex_to_rgba "$INACTIVE_BORDER")" >> "$OUTPUT"


echo "Generated $OUTPUT and $THEME with adaptive scheme from $WALLPAPER"

